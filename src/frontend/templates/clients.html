{% extends "base.html" %}

{% block title %}–ö–ª–∏–µ–Ω—Ç—ã - Sber Congratulations Agent{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-2">
                    <i class="bi bi-people"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
                </h1>
                <p class="text-muted">–ü—Ä–æ—Å–º–æ—Ç—Ä, –ø–æ–∏—Å–∫ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –¥–ª—è –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π.</p>
            </div>
            <div>
                <button class="btn btn-primary" onclick="loadClients()">
                    <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
                </button>
                <button class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#addClientModal">
                    <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, email, –∫–æ–º–ø–∞–Ω–∏–∏..." 
                                   onkeyup="searchClients()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="segmentFilter" onchange="filterClients()">
                            <option value="">–í—Å–µ —Å–µ–≥–º–µ–Ω—Ç—ã</option>
                            <option value="VIP">VIP</option>
                            <option value="–õ–æ—è–ª—å–Ω—ã–π">–õ–æ—è–ª—å–Ω—ã–π</option>
                            <option value="–ù–æ–≤—ã–π">–ù–æ–≤—ã–π</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="birthdayFilter" onchange="filterByBirthday()">
                            <option value="">–í—Å–µ –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è</option>
                            <option value="today">–î–† —Å–µ–≥–æ–¥–Ω—è</option>
                            <option value="week">–î–† –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ</option>
                            <option value="month">–î–† –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="text-muted">–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</h5>
                <h2 id="totalClientsCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="text-muted">VIP –∫–ª–∏–µ–Ω—Ç–æ–≤</h5>
                <h2 id="vipClientsCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="text-muted">–õ–æ—è–ª—å–Ω—ã—Ö</h5>
                <h2 id="loyalClientsCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="text-muted">–ù–æ–≤—ã—Ö</h5>
                <h2 id="newClientsCount">0</h2>
            </div>
        </div>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤</h5>
                <small class="text-muted" id="clientsCount">–ó–∞–≥—Ä—É–∑–∫–∞...</small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ò–º—è</th>
                                <th>Email</th>
                                <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
                                <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                                <th>–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</th>
                                <th>–°–µ–≥–º–µ–Ω—Ç</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                            <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
                <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ -->
<div class="modal fade" id="addClientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addClientForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–ò–º—è *</label>
                            <input type="text" class="form-control" name="first_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–§–∞–º–∏–ª–∏—è *</label>
                            <input type="text" class="form-control" name="last_name" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" class="form-control" name="phone" placeholder="+79161234567">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è *</label>
                            <input type="date" class="form-control" name="birthday" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–°–µ–≥–º–µ–Ω—Ç</label>
                            <select class="form-select" name="segment">
                                <option value="–ù–æ–≤—ã–π">–ù–æ–≤—ã–π</option>
                                <option value="–õ–æ—è–ª—å–Ω—ã–π">–õ–æ—è–ª—å–Ω—ã–π</option>
                                <option value="VIP">VIP</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–ö–æ–º–ø–∞–Ω–∏—è</label>
                        <input type="text" class="form-control" name="company_name">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                        <input type="text" class="form-control" name="position">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="addNewClient()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞ -->
<div class="modal fade" id="viewClientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-circle"></i> 
                    <span id="viewClientName">–ö–ª–∏–µ–Ω—Ç</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="viewClientContent">
                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-primary" onclick="generateForCurrentClient()">
                    <i class="bi bi-magic"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    let currentPage = 1;
    const itemsPerPage = 10;
    let allClients = [];
    let filteredClients = [];
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
    async function loadClients() {
        try {
            showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
            const data = await ApiClient.get('/clients?limit=1000');
            allClients = data;
            filteredClients = [...allClients];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateStatistics();
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            displayPage(1);
            
            hideLoading();
            
        } catch (error) {
            hideLoading();
            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤: ' + error.message, 'error');
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateStatistics() {
        // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        document.getElementById('totalClientsCount').textContent = allClients.length;
        
        // –ü–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º
        const vipCount = allClients.filter(c => c.segment === 'VIP').length;
        const loyalCount = allClients.filter(c => c.segment === '–õ–æ—è–ª—å–Ω—ã–π').length;
        const newCount = allClients.filter(c => c.segment === '–ù–æ–≤—ã–π').length;
        
        document.getElementById('vipClientsCount').textContent = vipCount;
        document.getElementById('loyalClientsCount').textContent = loyalCount;
        document.getElementById('newClientsCount').textContent = newCount;
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function displayPage(page) {
        currentPage = page;
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageClients = filteredClients.slice(startIndex, endIndex);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
        const tbody = document.getElementById('clientsTableBody');
        tbody.innerHTML = '';
        
        if (pageClients.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <div class="text-muted">
                            <i class="bi bi-people display-6"></i>
                            <p class="mt-2">–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            pageClients.forEach(client => {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç—Ä–æ–∫–∏ –ø–æ —Å–µ–≥–º–µ–Ω—Ç—É
                let rowClass = '';
                if (client.segment === 'VIP') rowClass = 'client-vip';
                else if (client.segment === '–õ–æ—è–ª—å–Ω—ã–π') rowClass = 'client-loyal';
                else if (client.segment === '–ù–æ–≤—ã–π') rowClass = 'client-new';
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è
                const birthday = new Date(client.birthday);
                const formattedBirthday = birthday.toLocaleDateString('ru-RU');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–µ–≥–æ–¥–Ω—è –ª–∏ –î–†
                const today = new Date();
                const isToday = birthday.getDate() === today.getDate() && 
                               birthday.getMonth() === today.getMonth();
                
                const birthdayCell = isToday 
                    ? `<span class="badge bg-danger">${formattedBirthday} üéÇ</span>`
                    : formattedBirthday;
                
                // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É
                const row = document.createElement('tr');
                row.className = rowClass;
                row.innerHTML = `
                    <td>${client.id}</td>
                    <td>
                        <strong>${client.full_name}</strong>
                        ${isToday ? '<span class="badge bg-warning ms-1">–î–† —Å–µ–≥–æ–¥–Ω—è!</span>' : ''}
                    </td>
                    <td>${client.email}</td>
                    <td>${client.company || '‚Äî'}</td>
                    <td>${client.position || '‚Äî'}</td>
                    <td>${birthdayCell}</td>
                    <td>
                        <span class="badge ${client.segment === 'VIP' ? 'bg-danger' : 
                                          client.segment === '–õ–æ—è–ª—å–Ω—ã–π' ? 'bg-warning' : 'bg-secondary'}">
                            ${client.segment}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewClient(${client.id})">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success ms-1" onclick="generateForClient(${client.id})">
                            <i class="bi bi-magic"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info ms-1" onclick="sendToClient(${client.id})">
                            <i class="bi bi-send"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        updatePagination();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
        document.getElementById('clientsCount').textContent = 
            `–ü–æ–∫–∞–∑–∞–Ω–æ ${pageClients.length} –∏–∑ ${filteredClients.length} –∫–ª–∏–µ–Ω—Ç–æ–≤`;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    function updatePagination() {
        const totalPages = Math.ceil(filteredClients.length / itemsPerPage);
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        // –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `
            <a class="page-link" href="#" onclick="displayPage(${currentPage - 1})">
                <i class="bi bi-chevron-left"></i>
            </a>
        `;
        pagination.appendChild(prevLi);
        
        // –°—Ç—Ä–∞–Ω–∏—Ü—ã
        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `
                <a class="page-link" href="#" onclick="displayPage(${i})">${i}</a>
            `;
            pagination.appendChild(li);
        }
        
        // –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `
            <a class="page-link" href="#" onclick="displayPage(${currentPage + 1})">
                <i class="bi bi-chevron-right"></i>
            </a>
        `;
        pagination.appendChild(nextLi);
    }
    
    // –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
    function searchClients() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        if (!searchTerm) {
            filteredClients = [...allClients];
        } else {
            filteredClients = allClients.filter(client => 
                client.full_name.toLowerCase().includes(searchTerm) ||
                client.email.toLowerCase().includes(searchTerm) ||
                (client.company && client.company.toLowerCase().includes(searchTerm)) ||
                (client.position && client.position.toLowerCase().includes(searchTerm))
            );
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å–µ–≥–º–µ–Ω—Ç—É, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω
        filterClients();
    }
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å–µ–≥–º–µ–Ω—Ç—É
    function filterClients() {
        const segment = document.getElementById('segmentFilter').value;
        
        if (segment) {
            filteredClients = filteredClients.filter(client => client.segment === segment);
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        displayPage(1);
    }
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–Ω—é —Ä–æ–∂–¥–µ–Ω–∏—è
    function filterByBirthday() {
        const filter = document.getElementById('birthdayFilter').value;
        const today = new Date();
        
        if (!filter) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
            searchClients();
            return;
        }
        
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫
        searchClients();
        
        // –ó–∞—Ç–µ–º —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
        filteredClients = filteredClients.filter(client => {
            const birthday = new Date(client.birthday);
            
            switch(filter) {
                case 'today':
                    return birthday.getDate() === today.getDate() && 
                           birthday.getMonth() === today.getMonth();
                
                case 'week':
                    // –î–† –≤ —Ç–µ—á–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–∏—Ö 7 –¥–Ω–µ–π
                    const nextWeek = new Date(today);
                    nextWeek.setDate(today.getDate() + 7);
                    
                    const birthdayThisYear = new Date(birthday);
                    birthdayThisYear.setFullYear(today.getFullYear());
                    
                    // –ï—Å–ª–∏ –î–† —É–∂–µ –ø—Ä–æ—à–µ–ª –≤ —ç—Ç–æ–º –≥–æ–¥—É, –±–µ—Ä–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≥–æ–¥
                    if (birthdayThisYear < today) {
                        birthdayThisYear.setFullYear(today.getFullYear() + 1);
                    }
                    
                    return birthdayThisYear >= today && birthdayThisYear <= nextWeek;
                
                case 'month':
                    return birthday.getMonth() === today.getMonth();
                
                default:
                    return true;
            }
        });
        
        displayPage(1);
    }
    
    // –ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ
    async function viewClient(clientId) {
        try {
            showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ...');
            
            const data = await ApiClient.get(`/clients/${clientId}`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById('viewClientName').textContent = data.client.full_name;
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã
            const birthday = new Date(data.client.birthday).toLocaleDateString('ru-RU');
            const created = new Date(data.client.created_at).toLocaleDateString('ru-RU');
            const updated = new Date(data.client.updated_at).toLocaleDateString('ru-RU');
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ–≥–º–µ–Ω—Ç
            let segmentBadge = '';
            if (data.client.segment === 'VIP') {
                segmentBadge = '<span class="badge bg-danger">VIP</span>';
            } else if (data.client.segment === '–õ–æ—è–ª—å–Ω—ã–π') {
                segmentBadge = '<span class="badge bg-warning">–õ–æ—è–ª—å–Ω—ã–π</span>';
            } else {
                segmentBadge = '<span class="badge bg-secondary">–ù–æ–≤—ã–π</span>';
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
            let content = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted">–ò–º—è</label>
                            <p class="fs-5">${data.client.first_name}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted">–§–∞–º–∏–ª–∏—è</label>
                            <p class="fs-5">${data.client.last_name}</p>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted">Email</label>
                            <p class="fs-5">${data.client.email}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                            <p class="fs-5">${data.client.phone || '‚Äî'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted">–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                            <p class="fs-5">${birthday} ${segmentBadge}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted">–°–µ–≥–º–µ–Ω—Ç</label>
                            <p class="fs-5">${data.client.segment}</p>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted">–ö–æ–º–ø–∞–Ω–∏—è</label>
                            <p class="fs-5">${data.client.company || '‚Äî'}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                            <p class="fs-5">${data.client.position || '‚Äî'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</label>
                            <p class="text-muted">${created}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</label>
                            <p class="text-muted">${updated}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π, –µ—Å–ª–∏ –µ—Å—Ç—å
            if (data.total_congratulations > 0) {
                content += `
                    <div class="mt-4 pt-3 border-top">
                        <h6>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π (${data.total_congratulations})</h6>
                        <div class="list-group mt-2" style="max-height: 200px; overflow-y: auto;">
                `;
                
                data.congratulations_history.forEach(congrat => {
                    const sentDate = new Date(congrat.sent_at).toLocaleDateString('ru-RU');
                    const statusClass = congrat.status === 'sent' ? 'status-sent' :
                                      congrat.status === 'pending' ? 'status-pending' : 'status-failed';
                    
                    content += `
                        <div class="list-group-item small">
                            <div class="d-flex justify-content-between">
                                <span>${sentDate} ‚Ä¢ ${congrat.event_type}</span>
                                <span>
                                    <span class="badge ${statusClass}">${congrat.status}</span>
                                    <span class="badge bg-info ms-1">${congrat.sent_via}</span>
                                </span>
                            </div>
                        </div>
                    `;
                });
                
                content += `
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('viewClientContent').innerHTML = content;
            
            hideLoading();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = new bootstrap.Modal(document.getElementById('viewClientModal'));
            modal.show();
            
        } catch (error) {
            hideLoading();
            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ: ' + error.message, 'error');
        }
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ (–≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ)
    async function generateForCurrentClient() {
        const modalTitle = document.getElementById('viewClientName').textContent;
        const clientId = modalTitle.split(' ')[0]; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ ID –≤ –Ω–∞—á–∞–ª–µ
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        bootstrap.Modal.getInstance(document.getElementById('viewClientModal')).hide();
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ
        await generateForClient(clientId);
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    async function addNewClient() {
        const form = document.getElementById('addClientForm');
        
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        const formData = new FormData(form);
        const clientData = Object.fromEntries(formData.entries());
        
        try {
            showLoading('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞...');
            
            const data = await ApiClient.post('/clients', clientData);
            
            showToast(data.message, 'success');
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            bootstrap.Modal.getInstance(document.getElementById('addClientModal')).hide();
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            form.reset();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
            loadClients();
            
        } catch (error) {
            hideLoading();
            showToast('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞: ' + error.message, 'error');
        }
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
    async function generateForClient(clientId) {
        try {
            showLoading('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è...');
            const data = await ApiClient.post(`/congratulations/generate?client_id=${clientId}`);
            
            showToast(`–ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è ${data.congratulation.client_name}`, 'success');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            showGeneratedText(data.congratulation);
            
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç—É
    async function sendToClient(clientId) {
        try {
            // –°–Ω–∞—á–∞–ª–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
            showLoading('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞...');
            const genData = await ApiClient.post(`/congratulations/generate?client_id=${clientId}`);
            
            // –ó–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
            showLoading('–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è...');
            const sendData = await ApiClient.post(
                `/congratulations/send?client_id=${clientId}&text=${encodeURIComponent(genData.congratulation.text)}&channel=email`
            );
            
            showToast(sendData.message, 'success');
            
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è showGeneratedText (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ base.html, –Ω–æ –ø—Ä–æ–¥—É–±–ª–∏—Ä—É–µ–º)
    function showGeneratedText(congratulation) {
        const modalHTML = `
            <div class="modal fade" id="generatedTextModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-chat-text"></i>
                                –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <strong>–î–ª—è:</strong> ${congratulation.client_name}<br>
                                <strong>–¢–æ–Ω:</strong> ${congratulation.tone}<br>
                                <strong>–î–ª–∏–Ω–∞:</strong> ${congratulation.length} —Å–∏–º–≤–æ–ª–æ–≤
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <pre style="white-space: pre-wrap; font-family: inherit;">${congratulation.text}</pre>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                            <button type="button" class="btn btn-primary" onclick="sendGeneratedText(${congratulation.client_id})">
                                <i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–æ–¥–∞–ª
        const oldModal = document.getElementById('generatedTextModal');
        if (oldModal) oldModal.remove();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
        const modal = new bootstrap.Modal(document.getElementById('generatedTextModal'));
        modal.show();
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    async function sendGeneratedText(clientId) {
        const text = document.querySelector('#generatedTextModal pre').textContent;
        
        try {
            showLoading('–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è...');
            const data = await ApiClient.post(
                `/congratulations/send?client_id=${clientId}&text=${encodeURIComponent(text)}&channel=email`
            );
            
            showToast(data.message, 'success');
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            bootstrap.Modal.getInstance(document.getElementById('generatedTextModal')).hide();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
            loadClients();
            
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadClients();
    });
</script>
{% endblock %}